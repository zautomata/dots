# coding: utf-8
#require 'rugged'
require 'httparty'
require 'zip/zip'
require 'octokit'
require 'ssd'
require 'language_sniffer'
require 'fileutils'


# hackspree allows you to study a specific user accross all the years and rounds via gitlapses.
#agent.get("https://code.google.com/codejam/contest/scoreboard/do?cmd=GetSourceCode&contest=3264486&problem=5736519012712448&io_set_id=0&username=#{username}").save("#{username}.zip")
#TODO delete all .zip files from the dir
module Hackspree 
  module Codejam

    # Builds codejam/index.ssd via going through the proper urls, extracting data and storing them
    def self.indexer
      response = HTTParty.get("https://code.google.com/codejam/past-contests?data=1")
      #:tournaments=>[{:contests=>[{:startDate=>"Mar 05 2017", :name=>"Kickstart Round A 2017", :analysis=>false, :startDateTime=>"2017-03-05T05:00:00+00:00", :duration=>"3hr", :id=>"8284486"}, {:startDate=>"Feb 19 2017", :name=>"Kickstart Practice Round 2017", :analysis=>false, :startDateTime=>"2017-02-19T05:00:00+00:00", :duration=>"3hr", :id=>"6304486"}], :grouping=>"Kickstart", :name=>"Kickstart 2017", :last_contest_start=>"2017-03-05T05:00:00+00:00", :display_language=>"en"}], :id=>"kickstart", :label=>"Kickstart"}
      data = eval(response.body)
      p "data: #{data}"
      index = {"problems" => [
                 #  {
                 #   :name=>"problemtitle1",
                 #   :site => "codejam",
                 #   :tournament => "somthing"
                 #  },
               ]}
      
      data[:tabs].each do |tab|
        tab[:tournaments].each do |tournament|
          #p "tournament: " + tournament[:name]
          tournament[:contests].each do |contest|
            p "NAME: "+contest[:name]+" ID: "+contest[:id]+" StartDateTime: "+contest[:startDateTime]
            contest_info = eval(HTTParty.get("https://code.google.com/codejam/contest/#{contest[:id]}/dashboard/ContestInfo").body)
            contest_info[:problems].each do |k,v|
              problem = Hash.new
              problem[:id] = k[:id]
              problem[:name] = k[:name]
              problem[:url] = "https://code.google.com/codejam/contest/#{contest[:id]}/dashboard"
              problem[:tournament_name] = tournament[:name]
              problem[:contest_id] = contest[:id]
              problem[:contest_name] = contest[:name]
              problem[:site] = "codejam"
              #p problem
              index["problems"] << problem
              #p k[:name]
              #p k[:id]
            end
          end
          #p "---------------------------"
        end
      end
      #puts response.body, response.code, response.message, response.headers.inspect
      #p data.keys
      #data[:rows].each do |d|
      #  p d
      #end
      index["count"] = index["problems"].count
      if (SSD.read("hackspree::codejam", "index")!= nil) then
        old_index = SSD.read("hackspree::codejam", "index")
      end
      if index != old_index then
        #index << problem.to_hash
        #index.uniq!
        SSD.write("hackspree::codejam", "index", index)
      end
    end

  end
end

#contest_id = "3264486"
#problem_id = "5736519012712448"
#Hackspree::Codejam.crawler(contest_id: contest_id, problem_id: problem_id)
#Hackspree::Codejam.indexer
#SSD.write("hackspree::solutions", "Year_Round_Level_#{language}", solution.to_hash)
#solution.append!
#response = HTTParty.get "https://code.google.com/codejam/contest/3264486/scoreboard/do/?cmd=GetScoreboard&contest_id=3264486&show_type=all&start_pos=1&csrfmiddlewaretoken=MDhiZDA1OThiMWEwOGQyZWQ0NjRkYzgwNjZmYTEyOTF8MTE3OTI2MzUyODM2NDczODY2NjA2fDE0OTI3MDk1MTA5ODc3MzA%3D"
